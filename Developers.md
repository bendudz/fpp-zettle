# Developing FPP Zettle

## FPP API
Check API methods at /api/help.php

We can get our config file from: 
GET /api/configfile/plugin.fpp-zettle.json



## Zettle API

### Create Event

Post request to url: https://pusher.izettle.com/organizations/self/subscriptions

Generate a UUID yourself. 

The destination will be put into the plugin config by the user, but is essentially the dataplicty address with our API endpoint on the end.

ie: https://unremarkable-cow-0123.dataplicity.io/api/plugin/fpp-zettle/event

Request body:
```json
{
  "uuid": "ef64c5e2-4e16-11e8-9c2d-fa7ae01bbebc",
  "transportName": "WEBHOOK",
  "eventNames": [
  "PurchaseCreated"
  ],
  "destination": "https://webhook.site/fb1a0755-a3ac-41ac-a996-7d1bf2106aae",
  "contactEmail": "fb1a0755-a3ac-41ac-a996-7d1bf2106aae@email.webhook.site"
}
```
Response - (Zettle says it uses signing key to verify request came from them - i read elsewhere it has no impact):

```json
{
    "uuid": "ef64c5e2-4e16-11e8-9c2d-fa7ae01bbebc",
    "transportName": "WEBHOOK",
    "eventNames": [
        "PurchaseCreated"
    ],
    "updated": "2022-04-25T15:24:32.185078Z",
    "destination": "https://webhook.site/fb1a0755-a3ac-41ac-a996-7d1bf2106aae",
    "contactEmail": "fb1a0755-a3ac-41ac-a996-7d1bf2106aae@email.webhook.site",
    "status": "ACTIVE",
    "signingKey": "wg1HcgcQSUY0kdTr5UllLtDWXRINszcVJS7942gmUuwoxasbUN0o6fyQtYDwuqa1"
}
```

### Testing the Zettle Pusher API recieves an Event.

I'm not sure atm what a Purchase message looks like. 

See https://developer.zettle.com/docs/api/pusher/user-guides/create-subscriptions

Can we extract any data?
Are we bothered?
Do we just trigger an effect?

Payload received:

```json
{
   "organizationUuid": "d3f03ffa-4a18-4282-bbfa-efd5f642ffb7",
   "messageUuid": "803f68c0-a110-11eb-a1cd-f7dd79ee0866",
   "eventName": "PurchaseCreated",
   "messageId": "2895af2a-faba-5f51-a1cd-f7dd79ee0866",
   "payload": "{\"purchaseUuid\":\"7cdf4ae2-a110-11eb-a7f9-24cfef8c2970\",\"source\":\"POS\",\"userUuid\":\"7a1abbf4-b5e2-4c70-8b21-f4ec5b00c463\",\"currency\":\"GBP\",\"country\":\"GB\",\"amount\":35300,\"vatAmount\":3656,\"timestamp\":1618837780798,\"created\":\"2021-04-19T13:09:40.798+0000\",\"gpsCoordinates\":{\"longitude\":18.11516501942474,\"latitude\":59.31182861328125,\"accuracyMeters\":14.014972079943288},\"purchaseNumber\":12776,\"userDisplayName\":\"John Smith\",\"udid\":\"692e074e16fb8e99cafbce1c975582c1ce8dbd8f\",\"organizationUuid\":\"d3f03ffa-4a18-4282-bbfa-efd5f642ffb7\",\"products\":[{\"id\":\"0\",\"productUuid\":\"4a98a670-7c2e-11eb-bb38-e398536ff6aa\",\"variantUuid\":\"4a98a671-7c2e-11eb-bb38-e398536ff6aa\",\"name\":\"testproduct\",\"variantName\":\"\",\"sku\":\"987\",\"unitPrice\":1200,\"quantity\":\"2\",\"vatPercentage\":0.0,\"taxRates\":[{\"percentage\":0}],\"taxExempt\":false,\"fromLocationUuid\":\"fd4a39a0-e2ef-11e6-ba64-85247ae2a737\",\"toLocationUuid\":\"fd4a87c0-e2ef-11e6-bfe3-78ba29c12242\",\"autoGenerated\":false,\"type\":\"PRODUCT\",\"details\":{}},{\"id\":\"1\",\"productUuid\":\"ffa4e654-987c-11eb-bd32-b9ba7d636d99\",\"variantUuid\":\"018ff152-987d-11eb-8147-faacf6e11cc8\",\"name\":\"Whiskey\",\"variantName\":\"50 cm\",\"sku\":\"The Whiskey - Small\",\"barcode\":\"30955168623\",\"unitPrice\":32900,\"costPrice\":0,\"quantity\":\"1\",\"vatPercentage\":12.5,\"taxRates\":[{\"percentage\":12.5}],\"taxExempt\":false,\"fromLocationUuid\":\"fd4a39a0-e2ef-11e6-ba64-85247ae2a737\",\"toLocationUuid\":\"fd4a87c0-e2ef-11e6-bfe3-78ba29c12242\",\"autoGenerated\":false,\"type\":\"PRODUCT\",\"details\":{}}],\"discounts\":[],\"payments\":[{\"uuid\":\"8031c38c-a110-11eb-a6f8-25ceee8d2871\",\"amount\":35300,\"type\":\"IZETTLE_CASH\",\"attributes\":{\"changeAmount\":0,\"handedAmount\":35300}}],\"references\":{\"checkoutUUID\":\"7cdf4ae2-a110-11eb-a6f8-25ceee8d2871\"},\"taxationMode\":\"INCLUSIVE\",\"taxationType\":\"VAT\"}",
   "timestamp": "2021-04-19T13:09:40.812Z"
}
```

### Config file lives in ~/media/config/

```shell
cat ~/media/config/plugin.fpp-zettle.json 
```
Config file:
```json
{
   "client_id": "36bf2d88-c1b6-11ec-b2c6-bb62f5c687b6",
   "client_secret": "somemassiveid",
   "organizationUuid": "0530e628-c1b1-11ec-ab70-336b73208bd4",
   "subscriptions": [
      {
         "contactEmail": "a0c47472-a6d6-4d1d-938b-a3979d46e151@email.webhook.site",
         "destination": "https://webhook.site/a0c47472-a6d6-4d1d-938b-a3979d46e151",
         "eventNames": [
            "PurchaseCreated"
         ],
         "signingKey": "TEJPW5mc0y6uzKhnC0g9w1mWuRUV7Y4p6bG27EYTKHMdU8pmxe8oOO9qgUX5m6w4",
         "status": "ACTIVE",
         "transportName": "WEBHOOK",
         "updated": "2022-04-25T23:44:36.190Z",
         "uuid": "ef64c5e2-4e16-11e8-9c2d-aa6ae01bbebc"
      }
   ]
}
```

### Transactions file lives in ~/media/config/

```shell
cat ~/media/config/plugin.fpp-zettle-transactions.json 
```
Config file:
```json
[
   {
      "organizationUuid": "d3f03ffa-4a18-4282-bbfa-efd5f642ffb7",
      "messageUuid": "803f68c0-a110-11eb-a1cd-f7dd79ee0866",
      "eventName": "PurchaseCreated",
      "messageId": "2895af2a-faba-5f51-a1cd-f7dd79ee0866",
      "payload": "{\"purchaseUuid\":\"7cdf4ae2-a110-11eb-a7f9-24cfef8c2970\",\"source\":\"POS\",\"userUuid\":\"7a1abbf4-b5e2-4c70-8b21-f4ec5b00c463\",\"currency\":\"GBP\",\"country\":\"GB\",\"amount\":35300,\"vatAmount\":3656,\"timestamp\":1618837780798,\"created\":\"2021-04-19T13:09:40.798+0000\",\"gpsCoordinates\":{\"longitude\":18.11516501942474,\"latitude\":59.31182861328125,\"accuracyMeters\":14.014972079943288},\"purchaseNumber\":12776,\"userDisplayName\":\"John Smith\",\"udid\":\"692e074e16fb8e99cafbce1c975582c1ce8dbd8f\",\"organizationUuid\":\"d3f03ffa-4a18-4282-bbfa-efd5f642ffb7\",\"products\":[{\"id\":\"0\",\"productUuid\":\"4a98a670-7c2e-11eb-bb38-e398536ff6aa\",\"variantUuid\":\"4a98a671-7c2e-11eb-bb38-e398536ff6aa\",\"name\":\"testproduct\",\"variantName\":\"\",\"sku\":\"987\",\"unitPrice\":1200,\"quantity\":\"2\",\"vatPercentage\":0.0,\"taxRates\":[{\"percentage\":0}],\"taxExempt\":false,\"fromLocationUuid\":\"fd4a39a0-e2ef-11e6-ba64-85247ae2a737\",\"toLocationUuid\":\"fd4a87c0-e2ef-11e6-bfe3-78ba29c12242\",\"autoGenerated\":false,\"type\":\"PRODUCT\",\"details\":{}},{\"id\":\"1\",\"productUuid\":\"ffa4e654-987c-11eb-bd32-b9ba7d636d99\",\"variantUuid\":\"018ff152-987d-11eb-8147-faacf6e11cc8\",\"name\":\"Whiskey\",\"variantName\":\"50 cm\",\"sku\":\"The Whiskey - Small\",\"barcode\":\"30955168623\",\"unitPrice\":32900,\"costPrice\":0,\"quantity\":\"1\",\"vatPercentage\":12.5,\"taxRates\":[{\"percentage\":12.5}],\"taxExempt\":false,\"fromLocationUuid\":\"fd4a39a0-e2ef-11e6-ba64-85247ae2a737\",\"toLocationUuid\":\"fd4a87c0-e2ef-11e6-bfe3-78ba29c12242\",\"autoGenerated\":false,\"type\":\"PRODUCT\",\"details\":{}}],\"discounts\":[],\"payments\":[{\"uuid\":\"8031c38c-a110-11eb-a6f8-25ceee8d2871\",\"amount\":35300,\"type\":\"IZETTLE_CASH\",\"attributes\":{\"changeAmount\":0,\"handedAmount\":35300}}],\"references\":{\"checkoutUUID\":\"7cdf4ae2-a110-11eb-a6f8-25ceee8d2871\"},\"taxationMode\":\"INCLUSIVE\",\"taxationType\":\"VAT\"}",
      "timestamp": "2021-04-19T13:09:40.812Z"
   }
]
```

### TODO

1. Register Domain either dataplicity or noip
   1. https://unrenowned-sheep-0265.dataplicity.io
2. Create subscription at zettle pointing at https://unrenowned-sheep-0265.dataplicity.io

